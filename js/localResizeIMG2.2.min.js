$.fn.localResizeIMG=function(b){this.on("change",function(){var e=this.files[0];var c=window.URL||window.webkitURL;var d=c.createObjectURL(e);if($.isFunction(b.before)){b.before(this,d,e)}a(d,e);this.value=""});function a(d){var c=new Image();c.src=d;c.onload=function(){var j=this;var f=j.width,i=j.height,k=f/i;f=b.width||f;i=f/k;var g=document.createElement("canvas");var e=g.getContext("2d");EXIF.getData(j,function(){$(g).attr({width:f,height:i});var p=EXIF.getTag(this,"Orientation");var q=f;var m=i;switch(p){case 8:$(g).attr({width:i,height:f});q=i;m=f;e.translate(0,f);e.rotate(-0.5*Math.PI);break;case 3:q=f;m=i;e.translate(f,i);e.rotate(Math.PI);break;case 6:$(g).attr({width:i,height:f});q=i;m=f;e.translate(i,0);e.rotate(0.5*Math.PI);break}e.drawImage(j,0,0,f,i);var l=g.toDataURL("image/jpeg",b.quality||0.8);if(navigator.userAgent.match(/iphone/i)){var o=new MegaPixImage(c);if(p!=1&&p!=undefined){o.render(g,{width:m,height:q,maxWidth:f,maxHeight:i,orientation:p,quality:b.quality||0.8});l=g.toDataURL("image/jpeg",b.quality||0.8)}else{o.render(g,{width:q,height:m,maxWidth:f,maxHeight:i,quality:b.quality||0.8});l=g.toDataURL("image/jpeg",b.quality||0.8)}}if(navigator.userAgent.match(/Android/i)){var n=new JPEGEncoder();l=n.encode(e.getImageData(0,0,q,m),b.quality*100||80)}var h={base64:l,clearBase64:l.substr(l.indexOf(",")+1)};b.success(h)})}}};